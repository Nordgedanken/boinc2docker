#!/bin/bash

set -e

TAG=$(git describe --tags --abbrev=0)

cd apps/boinc2docker/1.0

ensure_file() {
    test -f $1 && echo "Found locally: $1" || (echo "Downloading $1..."; curl -L $2 -o $1)
    grep '{"error":"Not Found"}' $1 && { echo "Download failed: $1"; rm $1; exit 1; } || :
}

RELEASE=$(curl https://api.github.com/repos/marius311/boinc2docker/releases/tags/$TAG)

ensure_file example/vm_isocontext_${TAG}.iso $(grep -oE "http.*vm_isocontext_${TAG}.iso" <<< "$RELEASE")

for platform in "x86_64-pc-linux-gnu" "windows_x86_64" "x86_64-apple-darwin"; do 
    
    platformdir=${platform}__vbox64_mt

    mkdir -p ${platformdir}
    cp example/version.xml example/vm_isocontext_${TAG}.iso ${platformdir}
    cp example/vm_cache.vdi ${platformdir}/vm_cache_${TAG}.vdi

    url=$(grep -oE "http.*vboxwrapper.*${platform}[^\"]*" <<< "$RELEASE")
    vboxwrapper=${url##*/}

    ensure_file example/$vboxwrapper $url
    cp example/$vboxwrapper $platformdir

    sed -i "s/%vboxwrapper%/$vboxwrapper/g" ${platformdir}/version.xml 
    sed -i "s/%tag%/$TAG/g" ${platformdir}/version.xml
done
