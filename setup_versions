#!/bin/bash

set -e

if [ "$#" -ne 3 ]; then
    echo "Usage: ./setup_versions <linux-vboxwrapper-version> <windows-vboxwrapper-version> <mac-vboxwrapper-version>"
    echo "Downloads the vboxwrapper executables and sets up the app version folders."
    echo "See http://boinc.berkeley.edu/dl/ for the latest vboxwrapper version."
    exit
fi

TAG=$(git describe --tags --abbrev=0 2>/dev/null || cat .tag)

cd apps/boinc2docker/1.0

if [ ! -f example/vm_isocontext_${TAG}.iso ]; then
    echo "Downloading boinc2docker ISO..."
    curl -L https://github.com/marius311/boinc2docker/releases/download/${TAG}/vm_isocontext.iso > example/vm_isocontext_${TAG}.iso
fi

for platform in x86_64-pc-linux-gnu windows_x86_64 x86_64-apple-darwin; do 
    mkdir -p ${platform}__vbox64_mt
    cp example/version.xml example/vm_isocontext_${TAG}.iso ${platform}__vbox64_mt
    cp example/vm_cache.vdi ${platform}__vbox64_mt/vm_cache_${TAG}.vdi
    cd ${platform}__vbox64_mt 
    vboxwrapper=vboxwrapper_$1_${platform} 
    if [[ $platform == "windows"* ]]; then vboxwrapper=${vboxwrapper}.exe; fi
    if [[ ! -f $vboxwrapper ]]; then
        if [[ ! -f vboxwrapper_$1_${platform}.zip ]]; then
            file=http://boinc.berkeley.edu/dl/vboxwrapper_$1_${platform}.zip
            echo "Downloading $file..."
            curl -LO $file
        fi
        files=$(unzip -j *.zip | grep inflating | awk '{print $NF}')
        rm ${files/$vboxwrapper/} *.zip
    fi
    sed -i "s/%vboxwrapper%/$vboxwrapper/g" version.xml 
    sed -i "s/%tag%/$TAG/g" version.xml
    cd ..
    shift 1
done
